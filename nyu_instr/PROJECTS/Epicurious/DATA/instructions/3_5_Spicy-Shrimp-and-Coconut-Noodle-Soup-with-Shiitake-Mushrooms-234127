For spice paste: Place all ingredients in blender. Process until paste forms. Can be made 1 day ahead. Transfer to small bowl, cover, and chill.
For soup: Heat 2 tablespoons peanut oil in large pot over medium-high heat. Add shrimp shells and cook until pink, stirring often, about 3 minutes. Add spice paste and half of onion; sauté until dry, about 3 minutes. Add fish sauce and sugar; stir until liquid is syrupy, about 2 minutes. Add coconut milk, broth, and mushroom stems. Bring just to boil, then reduce to medium-low, cover, and simmer 30 minutes. Strain soup into large pot, pressing on solids in strainer. Discard solids.
Meanwhile, place rice noodles in large heat-resistant bowl. Pour simmering water over to cover noodles; let stand at least 20 minutes to soften, stirring occasionally (noodles can stand in water up to 2 hours).
Heat remaining 1 tablespoon peanut oil in large nonstick skillet over medium heat. Add remaining onion and garlic; sauté until brown, stirring frequently, about 13 minutes. Add sesame oil, then sliced mushroom caps. Sauté until mushrooms are soft, about 4 minutes. Bring soup to simmer. Add mushroom mixture, shrimp, peanuts, and lime juice to soup. Simmer until shrimp is opaque, about 2 minutes.
Drain noodles; divide among 6 bowls. Ladle soup over noodles, dividing equally. Sprinkle soup with green onions and cilantro. Serve with lime wedges.
